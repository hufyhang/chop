!function(e,t){"use strict";var r=e,n="http://feifeihang.info/chop/loader.php?module=",i=function(e){return"[object Array]"===Object.prototype.toString.call(e)};Object.create||(Object.create=function(){function e(){}return function(t){if(1!==arguments.length)throw new Error("Object.create implementation only accepts one parameter.");return e.prototype=t,new e}}(),Object.keys||(Object.keys=function(e){var t=[];for(var r in e)e.hasOwnProperty(r)&&t.push(r);return t}));var a={el:t,html:"",render:function(){var e;return e="function"==typeof this.html?this.html():this.html,this.el===t?e:(this.el.innerHTML=e,void l._loadView(this.el))}},s={el:t,_views:[],focus:function(){return this.el.focus(),this},val:function(e){return e!==t?(this.el.value=e,this):this.el.value},html:function(e){return e?(this.el.innerHTML=e,this):this.el.innerHTML},append:function(e){return e!==t&&(this.el.innerHTML=this.el.innerHTML+e),this},show:function(){return this.el.style.display=this._display,this},hide:function(){return this._display=this.el.style.display,this.el.style.display="none",this},attr:function(e,t){return 0===arguments.length?this.el.attributes:(2===arguments.length&&this.el.setAttribute(e,t),this)},removeAttr:function(e){return l.isArray(e)&&l.each(e,function(e){this.el.removeAttribute(e)}),"string"==typeof e&&this.el.removeAttribute(e),this},on:function(e,t){if(2!==arguments.length)throw new Error("$ch.on requires an event and a callback parameter.");return this.el.addEventListener(e,t),this},click:function(e){return e!==t?(this.el.addEventListener("click",e),this):void this.el.click()},keypress:function(e){if(e===t)throw new Error("$ch.keypress requires a parameter.");return this.el.addEventListener("keypress",e),this},change:function(e){if(e===t)throw new Error("$ch.keypress requires a parameter.");return this.el.addEventListener("change",e),this},_cssReplacer:function(e,t){return t=t.replace(/-/g,""),t.toUpperCase()},css:function(e,t){return 0!==arguments.length?(e=e.replace(/(-[a-z])/g,this._cssReplacer),this.el.style[e]=t,this):this.el.style.cssText},view:function(e){if(e){var t=this.el;t.innerHTML="";var r=!1;if(i(e)){r=!0;for(var n=0;n!==e.length;++n){var a=e[n];this._addView(t,a,r)}}else this._addView(t,e);l._loadView(t)}return this},_addView:function(e,r,n){var i;i="function"==typeof r.html?r.html():r.html,i!==t&&(n===!0?e.innerHTML+=i:e.innerHTML=i),this._views.push(r)},inline:function(r){var n=this.el,a=n.id;if(a===t||l._inlineTemplates["#"+a]===t)throw new Error("ID attribute is mandatory for chop.js inline template.");var s,o,c,u,h,d=l._inlineTemplates["#"+a],f="";if(0===arguments.length){var p,g=n.getAttribute("ch-inline"),v=g.split("|"),m=v[0].trim();if(v.length>1)for(var w=1;w!==v.length;++w)v[w].trim().match(/filter\:.+/g)&&(p=v[w].trim().replace(/filter\:\ */g,""));r=p===t?l.source(m):l.filter(l.source(m),e[p])}if(i(r))for(u=0;u!==r.length;++u)for(f+=d,c=r[u],s=d.match(/{{.+?}}/g),h=0;h!==s.length;++h)o=s[h].replace(/{/g,""),o=o.replace(/}/g,""),f=f.replace(new RegExp(s[h],"g"),c[o]);else for(f=d,s=d.match(/{{.+?}}/g),c=r,h=0;h!==s.length;++h)o=s[h].replace(/{/g,""),o=o.replace(/}/g,""),f=f.replace(new RegExp(s[h],"g"),c[o]);return this.el.innerHTML=f,l._loadView(this.el),this}},l={_path:"",els:[],_chopEls:[],modules:{},sources:{},_isArray:i,isArray:i,indexOfElement:function(e){for(var t=0,r=this._chopEls.length;t!==r;++t){var n=this._chopEls[t];if(n.el===e)return t}return-1},find:function(e){if(e!==t){var r=document.querySelector(e);if(!r)return t;var n,i=this.indexOfElement(r);return-1===i?(n=Object.create(s),n.el=r,n._display=n.el.style.display,this._chopEls.push(n)):n=this._chopEls[i],n}throw new Error("$ch.find requires a parameter.")},findAll:function(e){if(e!==t){for(var r=document.querySelectorAll(e),n=[],i=0;i!==r.length;++i){var a,l=this.indexOfElement(r[i]);-1===l?(a=Object.create(s),a.el=r[i],a._display=a.el.style.display,this._chopEls.push(a)):a=this._chopEls[l],n[i]=a}return n}throw new Error("$ch.findAll requires a parameter.")},view:function(e){if(0===arguments.length)throw new Error("$ch.view requires a parameter.");var t=Object.create(a);return e.html&&(t.html=e.html),t},template:function(e,r){if(!e&&!r)throw new Error("invalid parameters for $ch.template.");if(!r)return e;var n=e.match(/{{.+?}}/g);return n&&n.forEach(function(n){var i=n.replace(/{/g,"");i=i.replace(/}/g,""),r[i]!==t&&(e=e.replace(n,r[i]))}),e=e.replace(/\\{/g,"{"),e=e.replace(/\\}/g,"}")},_addEvent:function(e,t,r){for(var n=e.querySelectorAll("["+t+"]"),i=0;i!==n.length;++i){var a=n[i].getAttribute(t);a=a.replace(/\$\$event/g,"arguments[0]");var s=a.match(/{{.+?}}/g);if(s)for(var l=0;l!==s.length;++l){var o=s[l],c=o.replace(/{/g,"");c=c.replace(/}/g,"");var u=c.split("|");if(1===u.length)a=a.replace(o,"$ch.sources."+c+".data");else{c=u[0].trim();for(var h=1;h!==u.length;++h){var d=u[h].trim(),f=null!==d.match(/filter\:.+/g);f&&(d=d.replace(/filter\:\ */g,""),a=a.replace(o,"$ch.filter($ch.sources."+c+".data, "+d+")"))}}}a=a.replace(/\\{/g,"{"),a=a.replace(/\\}/g,"}");var p=new Function(a);n[i].addEventListener(r,p)}},_registerEvents:function(e){e===t&&(e=document),this._addEvent(e,"ch-click","click"),this._addEvent(e,"ch-dbclick","dbclick"),this._addEvent(e,"ch-keypress","keypress"),this._addEvent(e,"ch-keydown","keydown"),this._addEvent(e,"ch-keyup","keyup"),this._addEvent(e,"ch-change","change"),this._addEvent(e,"ch-mousedown","mousedown"),this._addEvent(e,"ch-mouseup","mouseup"),this._addEvent(e,"ch-mouseenter","mouseenter"),this._addEvent(e,"ch-mousemove","mousemove"),this._addEvent(e,"ch-mouseout","mouseout"),this._addEvent(e,"ch-mouseover","mouseover"),this._addEvent(e,"ch-mouseleave","mouseleave")},_inlineTemplates:{},_renderInline:function(r){r===t&&(r=document);for(var n,a,s,o,c=r.querySelectorAll("[ch-inline]"),u=0;u!==c.length;++u){n=c[u];var h=n.getAttribute("id");if(h!==t){a=n.getAttribute("ch-inline"),a=a.replace(/{{/g,""),a=a.replace(/}}/g,"");var d=a.split("|");if(s=l.source(d[0].trim()),d.length>1)for(o=1;o!==d.length;++o){var f=d[o].trim(),p=null!==f.match(/filter\:.+/g);p&&(f=f.replace(/filter\:\ */g,""),s=l.filter(s,e[f]))}var g,v,m,w,y=n.innerHTML,E="";if(i(s))for(o=0;o!==s.length;++o)for(E+=y,m=s[o],g=y.match(/{{.+?}}/g),w=0;w!==g.length;++w)v=g[w].replace(/{/g,""),v=v.replace(/}/g,""),E=E.replace(new RegExp(g[w],"g"),m[v]);else for(E=y,g=y.match(/{{.+?}}/g),m=s,w=0;w!==g.length;++w)v=g[w].replace(/{/g,""),v=v.replace(/}/g,""),E=E.replace(new RegExp(g[w],"g"),m[v]);E=E.replace(/\\{/g,"{"),E=E.replace(/\\}/g,"{"),n.innerHTML=E,l._loadView(n)}}},_addInlineTemplate:function(e){e===t&&(e=document);for(var r=e.querySelectorAll("[ch-inline]"),n=0;n!==r.length;++n){var i=r[n],a=i.getAttribute("id");a!==t&&(l._inlineTemplates["#"+a]=i.innerHTML)}},_loadMain:function(){l._addInlineTemplate();var e=document.querySelector("script[ch-main]");if(null===e)return void l._loadView();var t=e.getAttribute("ch-main");if(this._path=t.substring(0,t.lastIndexOf("/")+1),t){var r=document.createElement("script");r.src=t,document.querySelector("head").appendChild(r),r.onload=function(){l._loadView()}}},_loadView:function(r){var n;r===t&&(r=document);for(var i=r.querySelectorAll("[ch-view]"),a=0;a!==i.length;++a){n=i[a].getAttribute("ch-view"),n=n.replace(/\ /g,""),i[a].innerHTML="";for(var s,o=n.split(","),c=0;c!==o.length;++c){s=o[c],e[s].el=t;var u=e[s].render();e[s].el=i[a],u&&(i[a].innerHTML+=u)}}l._registerEvents(r),l._bindSources(r),l._renderInline(r)},http:function(r){if(!r.url)throw new Error("URL parameter not found for $ch.http.");var n=r.url,i=r.method||"GET";i=i.toUpperCase();var a=r.data||{},s="";for(var l in a)a.hasOwnProperty(l)&&(s+=l+"="+a[l]+"&");a=s.slice(0,-1);var o=r.done||function(){return!1};r.async===t&&(r.async=!0);var c,u=r.async;c=e.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP"),c.open(i,n,u),c.onreadystatechange=function(){4===c.readyState&&u&&o({data:c.responseText,status:c.status})};var h=i&&"GET"!==i.toUpperCase()&&0!==a.length;return h?(c.setRequestHeader("Content-type","application/x-www-form-urlencoded"),c.send(a)):c.send(),u?void 0:c.responseText},define:function(e,t){this.modules[e]=t()},_useModule:function(e,t,r){var i,a=e,s=a.shift(),l=this,o=document.querySelector('script[ch-module="'+s+'"]');if(o)this._executeModule(a,t,r);else{var c=this._path+s+".js";t===!0&&-1===s.indexOf("-")&&(c=n+s);var u=this.http({url:c,method:"get",async:!1});i=document.createElement("script"),i.setAttribute("ch-module",s),i.text=u,document.querySelector("head").appendChild(i),l._executeModule(a,t,r)}},_executeModule:function(e,t,r){e.length>0?this._useModule(e,t,r):"function"==typeof r&&r()},require:function(e,r,n){return e?(n===t&&"function"==typeof r&&(n=r),("function"==typeof r||r===t)&&(r=!0),i(e)||(e=[e]),void this._useModule(e,r,n)):!1},module:function(e){return e!==t?this.modules[e]:this.modules},source:function(e,r){if(0===arguments.length)return this.sources;if(1===arguments.length){var n=this.sources[e];return n===t?t:n.data}var i=2===arguments.length&&this.sources[e]!==t;if(!i)return 2===arguments.length?(this.sources[e]={},this.sources[e].els=[],this.sources[e].data=r,this.sources[e]):!1;var a=this.sources[e];a.data=r;for(var s=0,l=a.els.length;s!==l;++s){var o=a.els[s],c=o.tagName.toUpperCase();"INPUT"===c||"TEXTAREA"===c?o.value=r:o.innerHTML=r}},_bindSources:function(e){e===t&&(e=document);for(var r=e.querySelectorAll("[ch-source]"),n=0;n!==r.length;++n){var i=r[n],a=i.getAttribute("ch-source"),s=this.sources[a],l="";s===t&&(this.sources[a]={},s=this.sources[a],s.els=[],i.value!==t&&(l=i.value)),s.els.push(i),s.data=l;var o=this;i.addEventListener("keyup",function(){var e=o.sources[this.getAttribute("ch-source")];e.data=this.value,e.els.forEach(function(t){var r,n=t.tagName.toUpperCase();r="INPUT"===n||"TEXTAREA"===n?"value":"innerHTML",t[r]!==e.data&&(t[r]=e.data)})})}},each:function(e,t){var r,n,a;if(2!==arguments.length)throw new Error("$ch.each requires two parameters (i.e. obj, callback).");if(r=t,i(e))for(a=0;a!==e.length;++a)n=e[a],r(n,a,e);else{var s=Object.keys(e);for(a=0;a!==s.length;++a){var l=s[a],o=e[l];r(l,o,a,e)}}},filter:function(e,r){var n=[];if(2!==arguments.length)throw new Error("$ch.filter requires two parameters (i.e. obj, expr).");if(e===t||null===e)return n;for(var i=0;i!==e.length;++i){var a=e[i];r(a)===!0&&n.push(a)}return n},store:function(e,r){if("undefined"==typeof Storage)throw new Error("Local storage is not supported by browser.");if(0===arguments.length)throw new Error("$ch.store requires at least one parameter.");if(1===arguments.length){var n=localStorage.getItem(e);return null!==n&&(n=JSON.parse(n)),n}if(r===t)throw new Error("$ch.store does not allow undefined value.");localStorage.setItem(e,JSON.stringify(r))}};r.$ch=l,r.$$CHOP=l,r.$$CHOPEL=s,r.$$CHOPVIEW=a,r.onload=function(){l._loadMain()}}(window);