!function(window,undefined){"use strict";var root=window,MODULE_LOADER="http://feifeihang.info/chop/loader.php?module=",_isArray=function(e){return"[object Array]"===Object.prototype.toString.call(e)};Object.create||(Object.create=function(){function e(){}return function(t){if(1!==arguments.length)throw new Error("Object.create implementation only accepts one parameter.");return e.prototype=t,new e}}(),Object.keys||(Object.keys=function(e){var t=[];for(var r in e)e.hasOwnProperty(r)&&t.push(r);return t}));var chopView={el:undefined,html:"",render:function(){var e;return e="function"==typeof this.html?this.html():this.html,this.el===undefined?e:(this.el.innerHTML=e,void chop._loadView(this.el))}},chopEl={el:undefined,_views:[],focus:function(){return this.el.focus(),this},val:function(e){return e!==undefined?(this.el.value=e,this):this.el.value},html:function(e){return e?(this.el.innerHTML=e,this):this.el.innerHTML},append:function(e){return e!==undefined&&(this.el.innerHTML=this.el.innerHTML+e),this},show:function(){return this.el.style.display=this._display,this},hide:function(){return this._display=this.el.style.display,this.el.style.display="none",this},attr:function(e,t){return 0===arguments.length?this.el.attributes:(2===arguments.length&&this.el.setAttribute(e,t),this)},removeAttr:function(e){return chop.isArray(e)&&chop.each(e,function(e){this.el.removeAttribute(e)}),"string"==typeof e&&this.el.removeAttribute(e),this},on:function(e,t){if(2!==arguments.length)throw new Error("$ch.on requires an event and a callback parameter.");return this.el.addEventListener(e,t),this},click:function(e){return e!==undefined?(this.el.addEventListener("click",e),this):void this.el.click()},keypress:function(e){if(e===undefined)throw new Error("$ch.keypress requires a parameter.");return this.el.addEventListener("keypress",e),this},change:function(e){if(e===undefined)throw new Error("$ch.keypress requires a parameter.");return this.el.addEventListener("change",e),this},_cssReplacer:function(e,t){return t=t.replace(/-/g,""),t.toUpperCase()},css:function(e,t){return 0!==arguments.length?(e=e.replace(/(-[a-z])/g,this._cssReplacer),this.el.style[e]=t,this):this.el.style.cssText},view:function(e){if(e){var t=this.el;t.innerHTML="";var r=!1;if(_isArray(e)){r=!0;for(var n=0;n!==e.length;++n){var i=e[n];this._addView(t,i,r)}}else this._addView(t,e);chop._loadView(t)}return this},_addView:function(e,t,r){var n;n="function"==typeof t.html?t.html():t.html,n!==undefined&&(r===!0?e.innerHTML+=n:e.innerHTML=n),this._views.push(t)},inline:function(e){var t=this.el,r=t.id;if(r===undefined||chop._inlineTemplates["#"+r]===undefined)throw new Error("ID attribute is mandatory for chop.js inline template.");var n,i,a,o,s,l=chop._inlineTemplates["#"+r],c="";if(0===arguments.length){var u,h=t.getAttribute("ch-inline"),d=h.split("|"),f=d[0].trim();if(d.length>1)for(var p=1;p!==d.length;++p)d[p].trim().match(/filter\:.+/g)&&(u=d[p].trim().replace(/filter\:\ */g,""));e=u===undefined?chop.source(f):chop.filter(chop.source(f),window[u])}if(_isArray(e))for(o=0;o!==e.length;++o)for(c+=l,a=e[o],n=l.match(/{{.+?}}/g),s=0;s!==n.length;++s)i=n[s].replace(/{/g,""),i=i.replace(/}/g,""),c=c.replace(new RegExp(n[s],"g"),a[i]);else for(c=l,n=l.match(/{{.+?}}/g),a=e,s=0;s!==n.length;++s)i=n[s].replace(/{/g,""),i=i.replace(/}/g,""),c=c.replace(new RegExp(n[s],"g"),a[i]);return this.el.innerHTML=c,chop._loadView(this.el),this}},chop={_path:"",els:[],_chopEls:[],modules:{},sources:{},_isArray:_isArray,isArray:_isArray,indexOfElement:function(e){for(var t=0,r=this._chopEls.length;t!==r;++t){var n=this._chopEls[t];if(n.el===e)return t}return-1},find:function(e){if(e!==undefined){var t=document.querySelector(e);if(!t)return undefined;var r,n=this.indexOfElement(t);return-1===n?(r=Object.create(chopEl),r.el=t,r._display=r.el.style.display,this._chopEls.push(r)):r=this._chopEls[n],r}throw new Error("$ch.find requires a parameter.")},findAll:function(e){if(e!==undefined){for(var t=document.querySelectorAll(e),r=[],n=0;n!==t.length;++n){var i,a=this.indexOfElement(t[n]);-1===a?(i=Object.create(chopEl),i.el=t[n],i._display=i.el.style.display,this._chopEls.push(i)):i=this._chopEls[a],r[n]=i}return r}throw new Error("$ch.findAll requires a parameter.")},view:function(e){if(0===arguments.length)throw new Error("$ch.view requires a parameter.");var t=Object.create(chopView);return e.html&&(t.html=e.html),t},template:function(e,t){if(!e&&!t)throw new Error("invalid parameters for $ch.template.");if(!t)return e;var r=e.match(/{{.+?}}/g);return r&&r.forEach(function(r){var n=r.replace(/{/g,"");n=n.replace(/}/g,""),t[n]!==undefined&&(e=e.replace(r,t[n]))}),e=e.replace(/\\{/g,"{"),e=e.replace(/\\}/g,"}")},_addEvent:function(e,t,r){for(var n=e.querySelectorAll("["+t+"]"),i=0;i!==n.length;++i){var a=n[i].getAttribute(t);a=a.replace(/\$\$event/g,"arguments[0]");var o=a.match(/{{.+?}}/g);if(o)for(var s=0;s!==o.length;++s){var l=o[s],c=l.replace(/{/g,"");c=c.replace(/}/g,"");var u=c.split("|");if(1===u.length)a=a.replace(l,"$ch.sources."+c+".data");else{c=u[0].trim();for(var h=1;h!==u.length;++h){var d=u[h].trim(),f=null!==d.match(/filter\:.+/g);f&&(d=d.replace(/filter\:\ */g,""),a=a.replace(l,"$ch.filter($ch.sources."+c+".data, "+d+")"))}}}a=a.replace(/\\{/g,"{"),a=a.replace(/\\}/g,"}");var p=new Function(a);n[i].addEventListener(r,p)}},_registerEvents:function(e){e===undefined&&(e=document),this._addEvent(e,"ch-click","click"),this._addEvent(e,"ch-dbclick","dbclick"),this._addEvent(e,"ch-keypress","keypress"),this._addEvent(e,"ch-keydown","keydown"),this._addEvent(e,"ch-keyup","keyup"),this._addEvent(e,"ch-change","change"),this._addEvent(e,"ch-mousedown","mousedown"),this._addEvent(e,"ch-mouseup","mouseup"),this._addEvent(e,"ch-mouseenter","mouseenter"),this._addEvent(e,"ch-mousemove","mousemove"),this._addEvent(e,"ch-mouseout","mouseout"),this._addEvent(e,"ch-mouseover","mouseover"),this._addEvent(e,"ch-mouseleave","mouseleave")},_inlineTemplates:{},_renderInline:function(e){e===undefined&&(e=document);for(var t,r,n,i,a=e.querySelectorAll("[ch-inline]"),o=0;o!==a.length;++o){t=a[o];var s=t.getAttribute("id");if(s!==undefined){r=t.getAttribute("ch-inline"),r=r.replace(/{{/g,""),r=r.replace(/}}/g,"");var l=r.split("|");if(n=chop.source(l[0].trim()),l.length>1)for(i=1;i!==l.length;++i){var c=l[i].trim(),u=null!==c.match(/filter\:.+/g);u&&(c=c.replace(/filter\:\ */g,""),n=chop.filter(n,window[c]))}var h,d,f,p,m=t.innerHTML,g="";if(_isArray(n))for(i=0;i!==n.length;++i)for(g+=m,f=n[i],h=m.match(/{{.+?}}/g),p=0;p!==h.length;++p)d=h[p].replace(/{/g,""),d=d.replace(/}/g,""),g=g.replace(new RegExp(h[p],"g"),f[d]);else for(g=m,h=m.match(/{{.+?}}/g),f=n,p=0;p!==h.length;++p)d=h[p].replace(/{/g,""),d=d.replace(/}/g,""),g=g.replace(new RegExp(h[p],"g"),f[d]);g=g.replace(/\\{/g,"{"),g=g.replace(/\\}/g,"{"),t.innerHTML=g,chop._loadView(t)}}},_addInlineTemplate:function(e){e===undefined&&(e=document);for(var t=e.querySelectorAll("[ch-inline]"),r=0;r!==t.length;++r){var n=t[r],i=n.getAttribute("id");i!==undefined&&(chop._inlineTemplates["#"+i]=n.innerHTML)}},_loadInit:function(baseElement){baseElement===undefined&&(baseElement=document);for(var elements=baseElement.querySelectorAll("[ch-init]"),index=0,len=elements.length;index!==len;++index){var element=elements[index],str=element.getAttribute("ch-init");if(str===undefined)return;for(var strs=str.trim().split(";"),i=0,l=strs.length;i!==l;++i){var init=strs[i].trim(),name=init.split("=")[0].trim();init=init.replace(/\'/g,"\\'"),init=init.replace(name,"data");var data=eval(init);this.source(name,data)}}},_loadMain:function(){chop._loadInit(),chop._addInlineTemplate();var e=document.querySelector("script[ch-main]");if(null===e)return void chop._loadView();var t=e.getAttribute("ch-main");if(this._path=t.substring(0,t.lastIndexOf("/")+1),t){var r=document.createElement("script");r.src=t,document.querySelector("head").appendChild(r),r.onload=function(){chop._loadView()}}},_loadView:function(e){var t;e===undefined&&(e=document);for(var r=e.querySelectorAll("[ch-view]"),n=0;n!==r.length;++n){t=r[n].getAttribute("ch-view"),t=t.replace(/\ /g,""),r[n].innerHTML="";for(var i,a=t.split(","),o=0;o!==a.length;++o){i=a[o],window[i].el=undefined;var s=window[i].render();window[i].el=r[n],s&&(r[n].innerHTML+=s)}}chop._loadInit(e),chop._registerEvents(e),chop._bindSources(e),chop._renderInline(e)},http:function(e){if(!e.url)throw new Error("URL parameter not found for $ch.http.");var t=e.url,r=e.method||"GET";r=r.toUpperCase();var n=e.data||{},i="";for(var a in n)n.hasOwnProperty(a)&&(i+=a+"="+n[a]+"&");n=i.slice(0,-1);var o=e.done||function(){return!1};e.async===undefined&&(e.async=!0);var s,l=e.async;s=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP"),s.open(r,t,l),s.onreadystatechange=function(){4===s.readyState&&l&&o({data:s.responseText,status:s.status})};var c=r&&"GET"!==r.toUpperCase()&&0!==n.length;return c?(s.setRequestHeader("Content-type","application/x-www-form-urlencoded"),s.send(n)):s.send(),l?void 0:s.responseText},define:function(e,t){this.modules[e]=t()},_useModule:function(e,t,r){var n,i=e,a=i.shift(),o=this,s=document.querySelector('script[ch-module="'+a+'"]');if(s)this._executeModule(i,t,r);else{var l=this._path+a+".js";t===!0&&-1===a.indexOf("-")&&(l=MODULE_LOADER+a);var c=this.http({url:l,method:"get",async:!1});n=document.createElement("script"),n.setAttribute("ch-module",a),n.text=c,document.querySelector("head").appendChild(n),o._executeModule(i,t,r)}},_executeModule:function(e,t,r){e.length>0?this._useModule(e,t,r):"function"==typeof r&&r()},require:function(e,t,r){return e?(r===undefined&&"function"==typeof t&&(r=t),("function"==typeof t||t===undefined)&&(t=!0),_isArray(e)||(e=[e]),void this._useModule(e,t,r)):!1},module:function(e){return e!==undefined?this.modules[e]:this.modules},source:function(e,t){if(0===arguments.length)return this.sources;if(1===arguments.length){var r=this.sources[e];return r===undefined?undefined:r.data}var n=2===arguments.length&&this.sources[e]!==undefined;if(!n)return 2===arguments.length?(this.sources[e]={},this.sources[e].els=[],this.sources[e].data=t,this.sources[e]):!1;var i=this.sources[e];i.data=t;for(var a=0,o=i.els.length;a!==o;++a){var s=i.els[a],l=s.tagName.toUpperCase();"INPUT"===l||"TEXTAREA"===l?s.value=t:s.innerHTML=t}},_bindSources:function(e){e===undefined&&(e=document);for(var t=e.querySelectorAll("[ch-source]"),r=0;r!==t.length;++r){var n=t[r],i=n.getAttribute("ch-source"),a=this.sources[i],o="";a===undefined&&(this.sources[i]={},a=this.sources[i],a.els=[],n.value!==undefined&&(o=n.value)),a.els.push(n),a.data=o;var s=this;n.addEventListener("keyup",function(){var e=s.sources[this.getAttribute("ch-source")];e.data=this.value,e.els.forEach(function(t){var r,n=t.tagName.toUpperCase();r="INPUT"===n||"TEXTAREA"===n?"value":"innerHTML",t[r]!==e.data&&(t[r]=e.data)})})}},each:function(e,t){var r,n,i;if(2!==arguments.length)throw new Error("$ch.each requires two parameters (i.e. obj, callback).");if(r=t,_isArray(e))for(i=0;i!==e.length;++i)n=e[i],r(n,i,e);else{var a=Object.keys(e);for(i=0;i!==a.length;++i){var o=a[i],s=e[o];r(o,s,i,e)}}},filter:function(e,t){var r=[];if(2!==arguments.length)throw new Error("$ch.filter requires two parameters (i.e. obj, expr).");if(e===undefined||null===e)return r;for(var n=0;n!==e.length;++n){var i=e[n];t(i)===!0&&r.push(i)}return r},store:function(e,t){if("undefined"==typeof Storage)throw new Error("Local storage is not supported by browser.");if(0===arguments.length)throw new Error("$ch.store requires at least one parameter.");if(1===arguments.length){var r=localStorage.getItem(e);return null!==r&&(r=JSON.parse(r)),r}if(t===undefined)throw new Error("$ch.store does not allow undefined value.");localStorage.setItem(e,JSON.stringify(t))}};root.$ch=chop,root.$$CHOP=chop,root.$$CHOPEL=chopEl,root.$$CHOPVIEW=chopView,root.onload=function(){chop._loadMain()}}(window);