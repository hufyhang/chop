$ch.define("widget",function(){"use strict";$ch.require("router");var e="chopjs:data-tunnel",t={},r={};$$CHOP.widget={},$$CHOP.widget={_widgets:{},_tunnel:{},register:function(e){var t=this;$$CHOP.each(e,function(e,r){t._widgets[e]={name:e,view:r}})},tunnel:{feed:function(e,r){if(2!==arguments.length)throw new Error("$ch.widget.tunnel.feed requires two parameters.");t[e]=r},fetch:function(e,t,n){if(3!==arguments.length)throw new Error("$ch.widget.tunnel.fetch requires three parameters.");r[t]=n;var i=document.getElementById(e).querySelector("iframe").contentWindow;i.postMessage({from:"HOST",signal:t},"*")},set:function(e,t){if(2!==arguments.length)throw new Error("$ch.widget.tunnel.set requires two parameters.");var r=JSON.stringify(t);r=encodeURIComponent(r),$$CHOP.widget._tunnel[e]=r},get:function(t,r,n){if(arguments.length<2)throw new Error("$ch.widget.tunnel.get requires at least two parameters.");if(null===document.getElementById(t))return void 0;var i=document.getElementById(t).querySelector("iframe").contentWindow.document;if(i=i.querySelector('head meta[typeof="'+e+'"][property="'+r+'"]'),null===i)return void 0;var o=i.getAttribute("content");if(null===o)return void 0;o=decodeURIComponent(o);var a=JSON.parse(o);return"string"==typeof n?a[n]:a}}},$$CHOP.router.add({"_chopjs_widget/:name/:data":function(t){var r={},n=t.data.split("&");$$CHOP.each(n,function(e){var t=e.split("=")[0].trim(),n=e.split("=")[1].trim();r[t]=n});var i,o=$$CHOP.widget._widgets[t.name];i=void 0===o?$$CHOP.view({html:"Oops! No such Chop.js widget."}):o.view(r);var a=document.querySelectorAll("body style"),d=document.querySelectorAll("body script");$$CHOP.find("body").view(i),$$CHOP.each(a,function(e){document.body.appendChild(e)}),$$CHOP.each(d,function(e){document.body.appendChild(e)}),$$CHOP.each($$CHOP.widget._tunnel,function(t,r){var n=document.createElement("meta");n.setAttribute("typeof",e),n.setAttribute("property",t),n.setAttribute("content",r),document.head.appendChild(n)});var c=document.body.scrollHeight,u=document.body.scrollWidth,l=window.location.href.split("#")[0],s=window.parent.window.document,m='ch-widget[src="'+l+'"][widget="'+t.name+'"] iframe';m+=null===l.match(/\/+$/)?', ch-widget[src="'+l+'/"][widget="'+t.name+'"] iframe':', ch-widget[src="'+l.replace(/\/+$/,"")+'"][widget="'+t.name+'"] iframe';var w=s.querySelectorAll(m);$$CHOP.each(w,function(e){e.style.height=c+"px",e.style.width=u+"px",e.style.border="none"})}}),window.addEventListener("message",function(e){e=e.data;var n,i,o,a;if("HOST"===e.from){if(n=window.parent.window,i=e.signal,o=t[i],void 0===o)return;n.postMessage({from:"WIDGET",signal:i,data:o},"*")}else if("WIDGET"===e.from){if(i=e.signal,o=e.data,a=r[i],void 0===a)return;a(o),delete r[i]}});var n=function(e){var t=e.querySelectorAll("ch-widget");$$CHOP.each(t,function(e){if(null===e.querySelector("iframe")){var t,r=e.getAttribute("src").trim(),n=e.getAttribute("widget").trim();t="/"===r.slice(-1)?"#/_chopjs_widget/":"/#/_chopjs_widget/",r=r+t+n;var i=[],o=e.querySelectorAll("ch-data");$$CHOP.each(o,function(e){var t=e.getAttribute("key").trim(),r=e.innerHTML;i.push(t+"="+r)}),r+="/"+i.join("&"),e.innerHTML='<iframe src="'+r+'"></iframe>'}})};n(document);var i=$$CHOP._loadView;$$CHOP._loadView=function(e){var t=!0;void 0===e&&(e=document,t=!1),i(e),n(e),t&&n(e)}});