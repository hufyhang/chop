$ch.define("widget",function(){"use strict";$ch.require("router");var a="chopjs:data-tunnel",b={},c={};$$CHOP.widget={},$$CHOP.widget={_widgets:{},_tunnel:{},register:function(a){var b=this;$$CHOP.each(a,function(a,c){b._widgets[a]={name:a,view:c}})},tunnel:{feed:function(a,c){if(2!==arguments.length)throw new Error("$ch.widget.tunnel.feed requires two parameters.");b[a]=c},fetch:function(a,b,d){if(3!==arguments.length)throw new Error("$ch.widget.tunnel.fetch requires three parameters.");c[b]=d;var e=document.getElementById(a).querySelector("iframe").contentWindow;e.postMessage({from:"HOST",signal:b},"*")},set:function(a,b){if(2!==arguments.length)throw new Error("$ch.widget.tunnel.set requires two parameters.");var c=JSON.stringify(b);c=encodeURIComponent(c),$$CHOP.widget._tunnel[a]=c},get:function(b,c,d){if(arguments.length<2)throw new Error("$ch.widget.tunnel.get requires at least two parameters.");if(null===document.getElementById(b))return void 0;var e=document.getElementById(b).querySelector("iframe").contentWindow.document;if(e=e.querySelector('head meta[typeof="'+a+'"][property="'+c+'"]'),null===e)return void 0;var f=e.getAttribute("content");if(null===f)return void 0;f=decodeURIComponent(f);var g=JSON.parse(f);return"string"==typeof d?g[d]:g}}},$$CHOP.router.add({"_chopjs_widget/:name/:data":function(b){var c={},d=b.data.split("&");$$CHOP.each(d,function(a){var b=a.split("=")[0].trim(),d=a.split("=")[1].trim();c[b]=d});var e,f=$$CHOP.widget._widgets[b.name];e=void 0===f?$$CHOP.view({html:"Oops! No such Chop.js widget."}):f.view(c);var g=document.querySelectorAll("body style"),h=document.querySelectorAll("body script");$$CHOP.find("body").view(e),$$CHOP.each(g,function(a){document.body.appendChild(a)}),$$CHOP.each(h,function(a){document.body.appendChild(a)}),$$CHOP.each($$CHOP.widget._tunnel,function(b,c){var d=document.createElement("meta");d.setAttribute("typeof",a),d.setAttribute("property",b),d.setAttribute("content",c),document.head.appendChild(d)});var i=document.body.scrollHeight,j=document.body.scrollWidth,k=window.location.href.split("#")[0],l=window.parent.window.document,m='ch-widget[src="'+k+'"][widget="'+b.name+'"] iframe';m+=null===k.match(/\/+$/)?', ch-widget[src="'+k+'/"][widget="'+b.name+'"] iframe':', ch-widget[src="'+k.replace(/\/+$/,"")+'"][widget="'+b.name+'"] iframe';var n=l.querySelectorAll(m);$$CHOP.each(n,function(a){a.style.height=i+"px",a.style.width=j+"px",a.style.border="none"})}}),window.addEventListener("message",function(a){a=a.data;var d,e,f,g;if("HOST"===a.from){if(d=window.parent.window,e=a.signal,f=b[e],void 0===f)return;d.postMessage({from:"WIDGET",signal:e,data:f},"*")}else if("WIDGET"===a.from){if(e=a.signal,f=a.data,g=c[e],void 0===g)return;g(f),delete c[e]}});var d=function(a){var b=a.querySelectorAll("ch-widget");$$CHOP.each(b,function(a){if(null===a.querySelector("iframe")){var b,c=a.getAttribute("src").trim(),d=a.getAttribute("widget").trim();b="/"===c.slice(-1)?"#/_chopjs_widget/":"/#/_chopjs_widget/",c=c+b+d;var e=[],f=a.querySelectorAll("ch-data");$$CHOP.each(f,function(a){var b=a.getAttribute("key").trim(),c=a.innerHTML;e.push(b+"="+c)}),c+="/"+e.join("&"),a.innerHTML='<iframe src="'+c+'"></iframe>'}})};d(document);var e=$$CHOP._loadView;$$CHOP._loadView=function(a){var b=!0;void 0===a&&(a=document,b=!1),e(a),d(a),b&&d(a)}});